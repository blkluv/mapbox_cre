<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    
    <!-- Mapbox & What3Words -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://cdn.what3words.com/javascript-components@4-latest/dist/what3words/what3words.js?key=29IK5VZP"></script>
    
    <title>WEEDW3W Dispensary Map</title>
    
    <style>
        body { margin: 0; padding: 0; background: #0a0a0a; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* Marker Styling */
        .marker {
            background-size: cover;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0px 0px 10px #00ffea;
            cursor: pointer;
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            0% { box-shadow: 0px 0px 5px #00ffea; }
            100% { box-shadow: 0px 0px 15px #00ffea; }
        }

        /* Popup Styling */
        .mapboxgl-popup {
            max-width: 300px;
            font: 14px/22px 'Arial', sans-serif;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 10px;
            padding: 10px;
        }

        .mapboxgl-popup-content img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        mapboxgl.accessToken = "pk.eyJ1IjoiZjFrdW5pIiwiYSI6ImNsaTl3Mmg5bDI2Z3ozcG53NTFnYzkyOHcifQ.kO1fY4a4TraHhQxoLYwTEg";

        // Initialize Map
        let map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/dark-v11",  // Futuristic dark theme
            center: [-74.4277, 39.3643], // Atlantic City
            zoom: 13
        });

        map.addControl(new mapboxgl.NavigationControl());

        // Dispensary Data
        const dispensaries = [
            {
                name: "Dispensary A",
                location: [-74.4300, 39.3680],
                image: "dispensary_a.jpg",
                info: "Best deals on edibles & flowers!"
            },
            {
                name: "Dispensary B",
                location: [-74.4250, 39.3620],
                image: "dispensary_b.jpg",
                info: "Premium organic strains available."
            },
        ];

        // Add Neon Markers
        dispensaries.forEach(dispensary => {
            const marker = document.createElement('div');
            marker.className = 'marker';
            marker.style.backgroundImage = 'url(weed_emoji.png)';

            new mapboxgl.Marker(marker)
                .setLngLat(dispensary.location)
                .setPopup(new mapboxgl.Popup().setHTML(`
                    <img src="${dispensary.image}" />
                    <h3>${dispensary.name}</h3>
                    <p>${dispensary.info}</p>
                `))
                .addTo(map);
        });

        // Glowing Roads Effect
        map.on("load", function () {
            map.addLayer({
                id: "glowing-roads",
                type: "line",
                source: "composite",
                "source-layer": "road",
                paint: {
                    "line-color": "#00ffea",
                    "line-width": 3,
                    "line-blur": 4
                }
            });

            // 3D Buildings
            map.addLayer({
                id: "3d-buildings",
                type: "fill-extrusion",
                source: "composite",
                "source-layer": "building",
                paint: {
                    "fill-extrusion-color": "#ff00ff",
                    "fill-extrusion-height": ["get", "height"],
                    "fill-extrusion-opacity": 0.7
                }
            });
        });

        // What3Words Grid System
        map.on("load", drawGrid).on("move", drawGrid);

        function drawGrid() {
            const zoom = map.getZoom();
            const loadFeatures = zoom > 11;

            if (loadFeatures) {
                var ne = map.getBounds().getNorthEast();
                var sw = map.getBounds().getSouthWest();

                what3words.api
                    .gridSectionGeoJson({
                        southwest: { lat: sw.lat, lng: sw.lng },
                        northeast: { lat: ne.lat, lng: ne.lng }
                    })
                    .then(function (data) {
                        var grid = map.getSource("grid");
                        if (!grid) {
                            map.addSource("grid", { type: "geojson", data: data });
                            map.addLayer({
                                id: "grid_layer",
                                type: "line",
                                source: "grid",
                                layout: { "line-join": "round", "line-cap": "round" },
                                paint: { "line-color": "#ffcc00", "line-width": 1 }
                            });
                        } else {
                            map.getSource("grid").setData(data);
                        }
                    })
                    .catch(console.error);
            }

            var grid_layer = map.getLayer("grid_layer");
            if (typeof grid_layer !== "undefined") {
                map.setLayoutProperty("grid_layer", "visibility", loadFeatures ? "visible" : "none");
            }
        }

        // Interactive Dice Roll Effect (Example Feature)
        function rollDice() {
            const roll = Math.floor(Math.random() * 6) + 1;
            new mapboxgl.Popup()
                .setLngLat(map.getCenter())
                .setHTML(`<h2>ðŸŽ² You rolled a ${roll}!</h2>`)
                .addTo(map);
        }

        document.addEventListener("keydown", function (event) {
            if (event.key === "r") { rollDice(); } // Press 'R' to roll dice
        });
    </script>
</body>
</html>
