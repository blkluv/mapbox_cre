<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ATL WAREHOUSE | COMMAND CENTER</title>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

  <style>
    :root {
      --aqua: #00f2ff;
      --pink: #ff007f;
      --neon-green: #39ff14;
      --glass: rgba(15, 15, 15, 0.90);
      --border: rgba(255, 255, 255, 0.1);
    }

    body { margin:0; padding:0; background:#050505; font-family: 'Inter', sans-serif; color: white; overflow: hidden; }
    #map { position:absolute; top:0; bottom:0; width:100%; }

    /* UI Layers */
    #header { position: fixed; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; pointer-events: none; }
    .brand { background: var(--glass); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 40px; border: 1px solid var(--border); font-weight: 900; color: var(--aqua); pointer-events: auto; }
    .stats-pill { background: var(--pink); color: white; padding: 8px 16px; border-radius: 40px; font-weight: 900; font-size: 11px; animation: pulse-red 2s infinite; pointer-events: auto; }

    #dock { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 1000; padding: 12px; background: var(--glass); backdrop-filter: blur(20px); border-radius: 100px; border: 1px solid var(--border); }
    .dock-btn { width: 48px; height: 48px; border-radius: 50%; border: none; background: rgba(255,255,255,0.05); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
    .dock-btn:hover { transform: scale(1.2); background: var(--aqua); color: black; }

    #sheet { position: fixed; left: 0; right: 0; bottom: 0; height: 60vh; background: #0a0a0a; border-radius: 30px 30px 0 0; transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000; padding: 30px; border-top: 2px solid var(--aqua); }
    #sheet.open { transform: translateY(0); }
    #sheet-close { position: absolute; right: 20px; top: 20px; background: none; border: none; color: white; font-size: 28px; cursor: pointer; }

    .grade-badge { font-size: 56px; font-weight: 900; color: var(--aqua); text-shadow: 0 0 20px rgba(0,242,255,0.4); }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 127, 0.6); } 70% { box-shadow: 0 0 0 15px rgba(255, 0, 127, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 127, 0); } }
  </style>
</head>
<body>

  <div id="header">
    <div class="brand">ATL // COMMAND</div>
    <div id="unit-count" class="stats-pill">INITIALIZING...</div>
  </div>

  <div id="map"></div>

  <div id="dock">
    <button class="dock-btn">ðŸ”¥</button>
    <button class="dock-btn">ðŸ‘·</button>
    <button class="dock-btn" style="background:var(--aqua); color:black;">+</button>
    <button class="dock-btn">âœ…</button>
  </div>

  <div id="sheet">
    <button id="sheet-close" onclick="closeSheet()">Ã—</button>
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
        <div>
            <h1 id="sheet-title" style="margin:0; font-size:24px; color:var(--aqua);">WAREHOUSE</h1>
            <p id="sheet-location" style="color:#888;">Industrial Hub</p>
        </div>
        <div class="grade-badge" id="sheet-grade">--</div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px;">
        <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:15px;">
            <div style="color:var(--aqua); font-size:10px; font-weight:900;">POWER</div>
            <div style="font-size:20px; font-weight:900;" id="sheet-power">-- MW</div>
        </div>
        <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:15px;">
            <div style="color:var(--pink); font-size:10px; font-weight:900;">DRAYAGE</div>
            <div style="font-size:20px; font-weight:900;" id="sheet-drayage">--</div>
        </div>
    </div>
    <button style="width:100%; margin-top:30px; padding:18px; border-radius:15px; border:none; background:var(--aqua); font-weight:900; cursor:pointer;">BOOK SITE VISIT</button>
  </div>

<script>
  let map;

  async function initMap() {
    const config = await fetch('/api/config').then(r => r.json());
    mapboxgl.accessToken = config.mapboxToken;

    map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/blkluv/cmm259s0u00eg01s322oh9vfd', 
      center: [-84.42, 33.64], 
      zoom: 10.5,
      pitch: 55
    });

    // CRITICAL: style.load ensures layers are added even after a style switch
    map.on('style.load', async () => {
      const response = await fetch('/api/facilities');
      const data = await response.json();
      
      document.getElementById('unit-count').innerText = `LIVE NETWORK: ${data.features.length} UNITS`;

      map.addSource('warehouses', {
        type: 'geojson',
        data: data
      });

      // Layer 1: Heatmap
      map.addLayer({
        id: 'warehouse-heat',
        type: 'heatmap',
        source: 'warehouses',
        paint: {
          'heatmap-intensity': 1,
          'heatmap-color': ['interpolate', ['linear'], ['heatmap-density'], 0, 'rgba(0,0,0,0)', 0.5, 'rgba(0,242,255,0.3)', 1, 'rgba(255,0,127,0.7)'],
          'heatmap-radius': 25,
          'heatmap-opacity': 0.5
        }
      });

      // Layer 2: Clickable Points
      map.addLayer({
        id: 'warehouse-points',
        type: 'circle',
        source: 'warehouses',
        paint: {
          'circle-radius': ['interpolate', ['linear'], ['zoom'], 10, 5, 15, 10],
          'circle-color': [
            'case',
            ['==', ['get', 'verified'], 1], '#ffd000',
            ['==', ['get', 'grade'], 'A'], '#00f2ff',
            '#ffffff'
          ],
          'circle-stroke-width': 1.5,
          'circle-stroke-color': '#000'
        }
      });

      map.on('click', 'warehouse-points', (e) => openSheet(e.features[0].properties));
      map.on('mouseenter', 'warehouse-points', () => map.getCanvas().style.cursor = 'pointer');
      map.on('mouseleave', 'warehouse-points', () => map.getCanvas().style.cursor = '');
    });
  }

  function openSheet(p) {
    document.getElementById('sheet-title').innerText = p.name;
    document.getElementById('sheet-power').innerText = (p.power_mw || '2.5') + ' MW';
    document.getElementById('sheet-grade').innerText = p.grade || 'C';
    document.getElementById('sheet-drayage').innerText = p.drayage_zone || 'OUTER';
    document.getElementById('sheet').classList.add('open');
  }

  function closeSheet() { document.getElementById('sheet').classList.remove('open'); }

  initMap();
</script>
</body>
</html>
