<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- Mapbox & What3Words -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdn.what3words.com/javascript-components@4-latest/dist/what3words/what3words.js?key=3UJB7WTL"></script>

    <title>MAP.</title>

    <style>
        body { margin: 0; padding: 0; background: #0a0a0a; font-family: Arial, sans-serif; }
        #map { position: absolute; top: 50px; bottom: 0; width: 100%; }

        /* Game Header */
        #header {
            position: fixed;
            top: 0;
            width: 100%;
            height: 50px;
            background: linear-gradient(90deg, #00ffea, #ff00ff);
            display: flex;
            align-items: center;
            justify-content: space-around;
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            z-index: 1000;
        }
        
        #header a {
            color: #fff;
            text-decoration: none;
            padding: 5px 8px;
            border-radius: 5px;
            transition: background 0.3s;
            white-space: nowrap;
        }

        #header a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Search Container */
        #search-container {
            position: absolute;
            top: 55px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: #222;
            color: #fff;
            font-size: 14px;
            outline: none;
            box-sizing: border-box;
        }

        .search-input::placeholder {
            color: #ccc;
        }

        .search-type {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .search-type button {
            background: #333;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .search-type button.active {
            background: #00ffea;
            color: #000;
        }

        /* Marker Styling */
        .marker {
            background-size: cover;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0px 0px 10px #00ffea;
            cursor: pointer;
            animation: pulse 1.5s infinite alternate;
        }

        .marker.atlantic {
            box-shadow: 0px 0px 10px #ff4444;
        }

        @keyframes pulse {
            0%   { box-shadow: 0px 0px 5px #00ffea; }
            100% { box-shadow: 0px 0px 15px #00ffea; }
        }

        .marker.atlantic {
            animation: pulseAtlantic 1.5s infinite alternate;
        }

        @keyframes pulseAtlantic {
            0%   { box-shadow: 0px 0px 5px #ff4444; }
            100% { box-shadow: 0px 0px 15px #ff4444; }
        }

        /* Popup Styling */
        .mapboxgl-popup-content {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            max-width: 300px;
        }

        .mapboxgl-popup-content img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }

        /* Location Filter */
        #filter-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(34, 34, 34, 0.9);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            gap: 10px;
        }

        #filter-container button {
            background: #00ffea;
            color: #000;
            border: none;
            padding: 8px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }

        #filter-container button:hover {
            background: #ff00ff;
            color: #fff;
        }

        /* Loading and Status */
        .status-message {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #00ffea;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            display: none;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #header {
                font-size: 12px;
                height: 45px;
            }
            
            #header a {
                padding: 4px 6px;
            }
            
            #search-container {
                top: 50px;
                width: 95%;
            }
            
            #filter-container {
                bottom: 10px;
                flex-direction: column;
                gap: 5px;
            }
            
            .search-type {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>

    <!-- Game Header -->
    <div id="header">
        <a href="http://map.atl5d.com">üó∫Ô∏è MAP.</a>
        <a href="http://pic.atl5d.com">‚ù§Ô∏è‚Äçüî• TV.</a>
        <a href="http://tiktok.com/@atl5d">ü§≥ TIKTOK</a>
    </div>

    <!-- Search Container -->
    <div id="search-container">
        <input id="address-input" type="text" class="search-input" placeholder="Enter street address (e.g. 123 Main St, Atlanta, GA)" onkeypress="searchAddress(event)" style="display: none;">
        <input id="w3w-input" type="text" class="search-input" placeholder="Enter What3Words (e.g. filled.count.soap)" onkeypress="searchW3W(event)">
        
        <div class="search-type">
            <button id="btn-address" onclick="setSearchType('address')">üìç Address</button>
            <button id="btn-w3w" onclick="setSearchType('w3w')" class="active">üî§ What3Words</button>
        </div>
    </div>

    <!-- Status Message -->
    <div id="status-message" class="status-message"></div>

    <!-- Location Filter -->
    <div id="filter-container">
        <button onclick="showAtlanta()">üìç ATLANTA</button>
        <button onclick="showAtlanticCity()">üé∞ ATLANTIC CITY</button>
        <button onclick="showAllLocations()">üåç SHOW ALL</button>
    </div>

    <div id="map"></div>

    <script>
        mapboxgl.accessToken = "pk.eyJ1IjoiZjFrdW5pIiwiYSI6ImNsaTl3Mmg5bDI2Z3ozcG53NTFnYzkyOHcifQ.kO1fY4a4TraHhQxoLYwTEg";

        let map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/dark-v11",
            center: [-79.5, 36.5],
            zoom: 5
        });

        map.addControl(new mapboxgl.NavigationControl());
        let currentSearchType = 'w3w';
        let tempMarkers = [];
        let what3wordsAPI;

        // Initialize What3Words API
        function initW3W() {
            what3wordsAPI = what3words();
            console.log("What3Words API initialized");
        }

        // Show status message
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.style.color = isError ? '#ff4444' : '#00ffea';
            statusEl.style.display = 'block';
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // Set search type
        function setSearchType(type) {
            currentSearchType = type;
            document.getElementById('btn-address').classList.remove('active');
            document.getElementById('btn-w3w').classList.remove('active');
            
            if (type === 'address') {
                document.getElementById('btn-address').classList.add('active');
                document.getElementById('address-input').style.display = 'block';
                document.getElementById('w3w-input').style.display = 'none';
                document.getElementById('address-input').focus();
            } else {
                document.getElementById('btn-w3w').classList.add('active');
                document.getElementById('address-input').style.display = 'none';
                document.getElementById('w3w-input').style.display = 'block';
                document.getElementById('w3w-input').focus();
            }
        }

        // Clear temporary markers
        function clearTempMarkers() {
            tempMarkers.forEach(marker => marker.remove());
            tempMarkers = [];
        }

        // Search by address and convert to What3Words
        function searchAddress(event) {
            if (event.key === "Enter") {
                let address = document.getElementById("address-input").value.trim();
                if (address) {
                    clearTempMarkers();
                    showStatus("Searching for address...");
                    
                    // Use Mapbox Geocoding to convert address to coordinates
                    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}&limit=1`)
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            if (data.features && data.features.length > 0) {
                                const [lng, lat] = data.features[0].center;
                                const placeName = data.features[0].place_name;
                                
                                // Fly to the location
                                map.flyTo({ center: [lng, lat], zoom: 15 });
                                
                                showStatus("Converting to What3Words...");
                                
                                // Convert coordinates to What3Words using direct API call
                                fetch(`https://api.what3words.com/v3/convert-to-3wa?coordinates=${lat},${lng}&key=3UJB7WTL`)
                                    .then(response => {
                                        if (!response.ok) throw new Error('W3W API response was not ok');
                                        return response.json();
                                    })
                                    .then(w3wResponse => {
                                        if (w3wResponse && w3wResponse.words) {
                                            const w3w = w3wResponse.words;
                                            
                                            // Add marker with both address and W3W info
                                            const marker = document.createElement("div");
                                            marker.className = "marker";
                                            marker.style.backgroundImage = "url(https://i.imgur.com/HZbull4.png)";
                                            marker.style.boxShadow = "0px 0px 15px #ffff00";
                                            
                                            const tempMarker = new mapboxgl.Marker(marker)
                                                .setLngLat([lng, lat])
                                                .setPopup(new mapboxgl.Popup().setHTML(`
                                                    <h3>üìç ${placeName}</h3>
                                                    <p><strong>What3Words:</strong> ///${w3w}</p>
                                                    <p><em>Address found and converted to W3W</em></p>
                                                    <a href="https://what3words.com/${w3w}" target="_blank" style="color: #00ffea;">Open in What3Words</a>
                                                `))
                                                .addTo(map);
                                            
                                            tempMarkers.push(tempMarker);
                                            
                                            // Update search field to show the W3W
                                            document.getElementById("w3w-input").value = w3w;
                                            showStatus("Address converted to What3Words!");
                                            
                                        } else {
                                            throw new Error('No W3W response');
                                        }
                                    })
                                    .catch(w3wError => {
                                        console.error("W3W conversion error:", w3wError);
                                        showStatus("Found address but couldn't convert to What3Words", true);
                                    });
                                
                            } else {
                                showStatus("Address not found. Please try a more specific address.", true);
                            }
                        })
                        .catch(error => {
                            console.error("Geocoding error:", error);
                            showStatus("Error searching for address. Please check your connection.", true);
                        });
                }
            }
        }

        // Search by What3Words and convert to address
        function searchW3W(event) {
            if (event.key === "Enter") {
                let words = document.getElementById("w3w-input").value.trim().toLowerCase();
                if (words) {
                    clearTempMarkers();
                    showStatus("Searching for What3Words location...");
                    
                    // Enhanced validation for what3words format
                    const w3wRegex = /^[a-z]+\.[a-z]+\.[a-z]+$/;
                    if (!w3wRegex.test(words)) {
                        showStatus("Please enter valid What3Words format: word.word.word", true);
                        return;
                    }
                    
                    // Use direct What3Words API call
                    fetch(`https://api.what3words.com/v3/convert-to-coordinates?words=${words}&key=3UJB7WTL`)
                        .then(response => {
                            if (!response.ok) throw new Error('W3W API response was not ok');
                            return response.json();
                        })
                        .then(response => {
                            if (response && response.coordinates) {
                                const { lat, lng } = response.coordinates;
                                
                                // Fly to the location
                                map.flyTo({ center: [lng, lat], zoom: 15 });
                                
                                showStatus("Converting to address...");
                                
                                // Convert coordinates back to address using Mapbox reverse geocoding
                                fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${mapboxgl.accessToken}&types=address,place`)
                                    .then(geoResponse => geoResponse.json())
                                    .then(geoData => {
                                        let address = "Address not found";
                                        if (geoData.features && geoData.features.length > 0) {
                                            address = geoData.features[0].place_name;
                                        }
                                        
                                        // Add marker with both W3W and address info
                                        const marker = document.createElement("div");
                                        marker.className = "marker";
                                        marker.style.backgroundImage = "url(https://i.imgur.com/HZbull4.png)";
                                        marker.style.boxShadow = "0px 0px 15px #ffff00";
                                        
                                        const tempMarker = new mapboxgl.Marker(marker)
                                            .setLngLat([lng, lat])
                                            .setPopup(new mapboxgl.Popup().setHTML(`
                                                <h3>üî§ ///${words}</h3>
                                                <p><strong>Address:</strong> ${address}</p>
                                                <p><em>What3Words converted to address</em></p>
                                                <a href="https://what3words.com/${words}" target="_blank" style="color: #00ffea;">Open in What3Words</a>
                                            `))
                                            .addTo(map);
                                        
                                        tempMarkers.push(tempMarker);
                                        
                                        // Update address field if visible
                                        document.getElementById("address-input").value = address;
                                        showStatus("What3Words converted to address!");
                                        
                                    })
                                    .catch(geoError => {
                                        console.error("Reverse geocoding error:", geoError);
                                        // Still add marker even if reverse geocoding fails
                                        const marker = document.createElement("div");
                                        marker.className = "marker";
                                        marker.style.backgroundImage = "url(https://i.imgur.com/HZbull4.png)";
                                        marker.style.boxShadow = "0px 0px 15px #ffff00";
                                        
                                        const tempMarker = new mapboxgl.Marker(marker)
                                            .setLngLat([lng, lat])
                                            .setPopup(new mapboxgl.Popup().setHTML(`
                                                <h3>üî§ ///${words}</h3>
                                                <p><em>What3Words location found</em></p>
                                                <a href="https://what3words.com/${words}" target="_blank" style="color: #00ffea;">Open in What3Words</a>
                                            `))
                                            .addTo(map);
                                        
                                        tempMarkers.push(tempMarker);
                                        showStatus("Location found but address conversion failed", true);
                                    });
                                
                            } else {
                                showStatus("Invalid What3Words address. Please check spelling.", true);
                            }
                        })
                        .catch(error => {
                            console.error("What3Words error:", error);
                            showStatus("Error: Unable to find this What3Words location.", true);
                        });
                }
            }
        }

        // Rest of your existing code for markers and locations...
        const locations = [
            {
                name: "Magic City Kitchen",
                location: [-84.3923, 33.7490],
                image: "https://i.imgur.com/fvjCvlx.jpeg",
                info: 'Visit <a href="https://what3words.com/famous.kitchen.magic" target="_blank" style="color: #00ffea;">///famous.kitchen.magic</a> for 15% OFF with code ATL5D',
                website: "https://magiccitykitchen.com",
                video: "https://www.youtube.com/shorts/ABf96TPBuqs",
                city: "atlanta"
            },
            {
                name: "HEAT Personal Training",
                location: [-84.3856, 33.7749],
                image: "https://i.imgur.com/WnZE6Vb.jpeg",
                info: 'Train at <a href="https://what3words.com/burn.sweat.heat" target="_blank" style="color: #00ffea;">///burn.sweat.heat</a> - First session FREE with code ATL5D',
                website: "https://heatpersonaltraining.com",
                video: "https://www.youtube.com/shorts/t84JpJ6iglo",
                city: "atlanta"
            },
            {
                name: "MARTA Five Points Station",
                location: [-84.3915, 33.7541],
                image: "https://i.imgur.com/5qlQfGA.png",
                info: 'Central hub at <a href="https://what3words.com/connect.transit.city" target="_blank" style="color: #00ffea;">///connect.transit.city</a> - Show ATL5D badge for express lane',
                website: "https://itsmarta.com",
                video: "https://www.youtube.com/shorts/HgY3myHKcQ4",
                city: "atlanta"
            },
            {
                name: "Ariskbiu Ice Cream",
                location: [-84.3782, 33.7489],
                image: "https://i.imgur.com/ARISKBIIUIMAGE.png",
                info: 'Black-owned delight at <a href="https://what3words.com/sweet.cream.black" target="_blank" style="color: #00ffea;">///sweet.cream.black</a> - BOGO with code ATL5D',
                website: "https://ariskbiucream.com",
                video: "https://www.youtube.com/embed/ARISKBIIUVIDEOID",
                city: "atlanta"
            },
            {
                name: "High Rollers Atlantic City Dispensary",
                location: [-74.432096, 39.35798], 
                image: "https://i.imgur.com/RjWVKhN.png",
                info: 'Visit <a href="https://what3words.com/film.client.darker" target="_blank" style="color: #00ffea;">///film.client.darker</a> for 50% OFF with WEEDW3W1',
                website: "https://highrollersac.com",
                video: "https://gateway.pinata.cloud/ipfs/QmYourVideoHash",
                city: "atlantic"
            }
        ];

        let markers = [];

        // Add All Markers
        function addAllMarkers() {
            markers.forEach(marker => marker.remove());
            markers = [];

            locations.forEach(location => {
                const marker = document.createElement("div");
                marker.className = "marker";
                if (location.city === "atlantic") {
                    marker.classList.add("atlantic");
                }
                marker.style.backgroundImage = "url(https://i.imgur.com/HZbull4.png)";

                const mapMarker = new mapboxgl.Marker(marker)
                    .setLngLat(location.location)
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <img src="${location.image}" />
                        <h3>${location.name}</h3>
                        <p>${location.info}</p>
                        <a href="${location.website}" target="_blank" style="color: #00ffea;">üåê Visit Website</a><br>
                        <a href="${location.video}" target="_blank" style="color: #ff00ff;">üìπ Watch Reel</a>
                    `))
                    .addTo(map);

                markers.push(mapMarker);
            });
        }

        // Show All Locations
        function showAllLocations() {
            addAllMarkers();
            map.flyTo({
                center: [-79.5, 36.5],
                zoom: 5,
                essential: true
            });
        }

        // Show Only Atlanta
        function showAtlanta() {
            markers.forEach(marker => marker.remove());
            markers = [];

            locations.filter(loc => loc.city === "atlanta").forEach(location => {
                const marker = document.createElement("div");
                marker.className = "marker";
                marker.style.backgroundImage = "url(https://i.imgur.com/HZbull4.png)";

                const mapMarker = new mapboxgl.Marker(marker)
                    .setLngLat(location.location)
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <img src="${location.image}" />
                        <h3>${location.name}</h3>
                        <p>${location.info}</p>
                        <a href="${location.website}" target="_blank" style="color: #00ffea;">üåê Visit Website</a><br>
                        <a href="${location.video}" target="_blank" style="color: #ff00ff;">üìπ Watch Reel</a>
                    `))
                    .addTo(map);

                markers.push(mapMarker);
            });

            map.flyTo({
                center: [-84.3989, 33.7917],
                zoom: 13,
                essential: true
            });
        }

        // Show Only Atlantic City
        function showAtlanticCity() {
            markers.forEach(marker => marker.remove());
            markers = [];

            locations.filter(loc => loc.city === "atlantic").forEach(location => {
                const marker = document.createElement("div");
                marker.className = "marker atlantic";
                marker.style.backgroundImage = "url(https://i.imgur.com/HZbull4.png)";

                const mapMarker = new mapboxgl.Marker(marker)
                    .setLngLat(location.location)
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <img src="${location.image}" />
                        <h3>${location.name}</h3>
                        <p>${location.info}</p>
                        <a href="${location.website}" target="_blank" style="color: #00ffea;">üåê Visit Website</a><br>
                        <a href="${location.video}" target="_blank" style="color: #ff00ff;">üìπ Watch Reel</a>
                    `))
                    .addTo(map);

                markers.push(mapMarker);
            });

            map.flyTo({
                center: [-74.432096, 39.35798],
                zoom: 15,
                essential: true
            });
        }

        // Initialize with all markers
        addAllMarkers();

        // Set default search type
        setSearchType('w3w');

        // Initialize What3Words when the script loads
        document.addEventListener('DOMContentLoaded', function() {
            initW3W();
        });
    </script>
</body>
</html>
