<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ATL WAREHOUSE</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; height:100%; }
        #counter { position:fixed; top:10px; left:10px; background:black; color:#00ffea; padding:10px; z-index:1000; }
    </style>
</head>
<body>
    <div id="counter">LOADING...</div>
    <div id="map"></div>

<script>
    // IMPORTANT: Replace with your actual token
    mapboxgl.accessToken = "YOUR_MAPBOX_TOKEN";
    
    // Initialize map
    const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/dark-v11",
        center: [-84.39, 33.77], // Atlanta
        zoom: 10
    });

    // Wait for map to load
    map.on('load', () => {
        console.log("Map loaded successfully");
        document.getElementById('counter').innerText = "MAP LOADED";
        
        // ADD TEST MARKER - This confirms map is working
        const el = document.createElement('div');
        el.style.width = '20px';
        el.style.height = '20px';
        el.style.backgroundColor = '#00ffea';
        el.style.borderRadius = '50%';
        el.style.border = '2px solid white';
        
        new mapboxgl.Marker({ element: el })
            .setLngLat([-84.39, 33.77]) // Atlanta
            .setPopup(new mapboxgl.Popup().setHTML("<h3>TEST MARKER</h3><p>Map is working!</p>"))
            .addTo(map);
            
        document.getElementById('counter').innerText = "TEST MARKER ADDED";
        
        // Now try to load real facilities
        loadFacilities();
    });

    // Handle map errors
    map.on('error', (e) => {
        console.error("Map error:", e);
        document.getElementById('counter').innerText = "MAP ERROR - CHECK TOKEN";
    });

    async function loadFacilities() {
        try {
            document.getElementById('counter').innerText = "FETCHING FACILITIES...";
            
            // DIRECT OVERPASS API CALL (bypassing your backend for testing)
            const query = `
                [out:json][timeout:25];
                (
                    node["building"="warehouse"](33.45,-84.75,34.05,-84.05);
                    way["building"="warehouse"](33.45,-84.75,34.05,-84.05);
                );
                out center;
            `;
            
            const response = await fetch("https://overpass-api.de/api/interpreter", {
                method: "POST",
                body: query
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log("Overpass data:", data);
            
            const elements = data.elements || [];
            document.getElementById('counter').innerText = `FOUND ${elements.length} WAREHOUSES`;
            
            elements.forEach((el, index) => {
                let coords;
                
                if (el.type === "node") {
                    coords = [el.lon, el.lat];
                } else if (el.type === "way" && el.center) {
                    coords = [el.center.lon, el.center.lat];
                } else {
                    return; // Skip if no coordinates
                }
                
                if (!coords || !coords[0] || !coords[1]) return;
                
                // Create marker
                const markerEl = document.createElement('div');
                markerEl.style.width = '12px';
                markerEl.style.height = '12px';
                markerEl.style.backgroundColor = '#ff00ff';
                markerEl.style.borderRadius = '50%';
                markerEl.style.border = '2px solid white';
                markerEl.style.cursor = 'pointer';
                
                const marker = new mapboxgl.Marker({ element: markerEl })
                    .setLngLat(coords)
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <div style="color:black; padding:10px;">
                            <h3>${el.tags?.name || 'Warehouse ' + index}</h3>
                            <p>Type: ${el.type}</p>
                            <p>ID: ${el.id}</p>
                        </div>
                    `))
                    .addTo(map);
                
                console.log(`Added marker ${index} at:`, coords);
            });
            
        } catch (err) {
            console.error("Failed to load:", err);
            document.getElementById('counter').innerText = "ERROR: " + err.message;
        }
    }
</script>
</body>
</html>
