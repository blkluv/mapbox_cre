<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ATLWarehouse Grid</title>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0a0a0a;
      --card:rgba(12,12,12,.92);
      --stroke:rgba(255,255,255,.10);
      --text:#fff;
      --muted:#b8b8b8;
      --aqua:#00ffea;
      --pink:#ff00ff;
      --gold:#ffd000;
      --inspected:#ff7cff;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 16px;
    }

    body{ margin:0; padding:0; background:var(--bg); font-family: Arial, sans-serif; }
    #map{ position:absolute; top:64px; bottom:0; width:100%; }

    /* Header */
    #header{
      position:fixed; top:0; left:0; right:0; height:64px;
      background: linear-gradient(90deg, var(--aqua), var(--pink));
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:0 10px; z-index:1000; flex-wrap:wrap;
    }
    #header a{
      display:flex; align-items:center; gap:8px;
      color:#000; text-decoration:none; background:#fff;
      padding:8px 12px; border-radius: 12px;
      font-weight:900; font-size:14px;
      box-shadow: 0 10px 28px rgba(0,0,0,.22);
      white-space:nowrap;
    }

    /* Top Control Bar */
    #controls{
  position:absolute;
  top:74px;
  left:10px;
  right:10px;
  z-index:3000;   /* raise above map */
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
}

    .control-card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:10px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      max-width: 100%;
    }

    .chip{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; gap:8px;
    }
    .chip.active{
      background: rgba(0,255,234,.18);
      border-color: rgba(0,255,234,.45);
      color: var(--aqua);
    }

    .segmented{
      display:flex; gap:0; overflow:hidden;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .segmented button{
      border:none; background:transparent; color: var(--text);
      padding:10px 12px; font-weight:900; font-size:13px;
      cursor:pointer;
    }
    .segmented button.active{
      background: rgba(255,0,255,.18);
      color:#fff;
    }

    .btn{
      border:none; cursor:pointer;
      border-radius: 12px;
      padding:10px 12px;
      font-weight:900;
      background: var(--aqua);
      color:#000;
    }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
    }

    /* Bottom Sheet */
    #sheet{
      position:fixed; left:0; right:0; bottom:0;
      height: 72%;
      max-height: 600px;
      background: rgba(10,10,10,.96);
      border-top: 1px solid rgba(255,255,255,.10);
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      box-shadow: 0 -18px 80px rgba(0,0,0,.70);
      transform: translateY(110%);
      transition: transform .22s ease;
      z-index: 1100;
      display:flex; flex-direction:column;
    }
    #sheet.open{ transform: translateY(0); }

    #sheet-handle{
      height: 44px;
      display:flex; align-items:center; justify-content:center;
      position:relative;
      cursor:grab;
    }
    #sheet-handle:before{
      content:"";
      width: 56px; height: 6px;
      background: rgba(255,255,255,.18);
      border-radius: 999px;
    }
    #sheet-close{
      position:absolute; right:14px; top:10px;
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }

    #sheet-content{
      padding: 0 14px 14px;
      overflow:auto;
    }

    .title-row{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:flex-start; justify-content:space-between;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      margin-bottom: 12px;
    }
    .facility-title{
      margin:0; font-size:18px; font-weight:900;
      color: var(--aqua);
      line-height:1.15;
    }
    .badges{ display:flex; gap:8px; flex-wrap:wrap; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      font-size: 12px;
      font-weight: 900;
      color:#fff;
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .badge.verified{ background: rgba(255,208,0,.16); border-color: rgba(255,208,0,.35); }
    .badge.inspected{ background: rgba(255,124,255,.16); border-color: rgba(255,124,255,.35); }
    .badge.public{ background: rgba(0,255,234,.12); border-color: rgba(0,255,234,.30); }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom: 12px;
    }
    .stat{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding:10px;
    }
    .stat .k{ font-size:12px; color: var(--muted); font-weight:800; }
    .stat .v{ font-size:15px; color:#fff; font-weight:900; margin-top:4px; }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .tab{
      padding:10px 12px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#fff; font-weight:900; font-size:13px; cursor:pointer;
    }
    .tab.active{
      background: rgba(0,255,234,.18);
      border-color: rgba(0,255,234,.45);
      color: var(--aqua);
    }
    .tab-panel{ display:none; }
    .tab-panel.active{ display:block; }

    .kv{ margin: 8px 0; color:#ddd; font-size:13px; line-height:1.35; }
    .kv strong{ color:#fff; }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 12px;
    }
    .action{
      flex:1;
      border:none; cursor:pointer;
      border-radius: 14px;
      padding: 12px 12px;
      font-weight: 900;
      background: var(--aqua);
      color:#000;
    }
    .action.secondary{
      background: rgba(255,255,255,.08);
      color:#fff;
      border: 1px solid rgba(255,255,255,.12);
    }

    /* Small screen tweaks */
    @media (max-width: 420px){
      .grid{ grid-template-columns: 1fr; }
      #controls{ top:72px; }
    }

    /* Mapbox popup hidden (we‚Äôre not using popups) */
    .mapboxgl-popup{ display:none !important; }
  </style>
</head>
<body>

  <div id="header">
    <a href="https://ops.atlwarehouse.com">‚öôÔ∏è OPS</a>
    <a href="https://atlwarehouse.com">üè† HOME</a>
    <a href="https://tiktok.com/@atlwarehouse">üéµ TIKTOK</a>
    <a href="https://tv.atlwarehouse.com">üì∫ TV</a>
  </div>

  <div id="controls">
    <div class="control-card">
      <div id="chip-verified" class="chip">‚úÖ Verified</div>
      <div id="chip-capacity" class="chip">üìä Capacity &lt; 75%</div>

      <div class="segmented" aria-label="Heatmap mode">
        <button id="heat-labor" class="active" type="button">üë∑ Labor</button>
        <button id="heat-util" type="button">üì¶ Util</button>
        <button id="heat-verified" type="button">üè∑ Verified</button>
      </div>

      <button id="btn-submarkets" class="btn secondary" type="button">üó∫ Submarkets</button>
      <button id="btn-heat" class="btn secondary" type="button">üî• Heat</button>
    </div>

    <div class="control-card">
      <button id="btn-atl" class="btn" type="button">üìç Atlanta</button>
      <button id="btn-fit" class="btn secondary" type="button">üß≠ Fit</button>
      <button id="btn-list" class="btn secondary" type="button">üèÜ List</button>
    </div>
  </div>

  <div id="map"></div>

  <!-- Bottom Sheet -->
  <div id="sheet" aria-hidden="true">
    <div id="sheet-handle">
      <button id="sheet-close" title="Close">√ó</button>
    </div>
    <div id="sheet-content">
      <div class="title-row">
        <div>
          <h2 id="sheet-title" class="facility-title">Facility</h2>
          <div id="sheet-subtitle" class="kv" style="margin:6px 0 0; color:#bdbdbd;">Atlanta Industrial</div>
        </div>
        <div id="sheet-badges" class="badges"></div>
      </div>

      <div class="grid" id="sheet-stats"></div>

      <div class="tabs">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="ops">Ops</button>
        <button class="tab" data-tab="labor">Labor</button>
        <button class="tab" data-tab="tech">Tech</button>
        <button class="tab" data-tab="media">Media</button>
      </div>

      <div id="tab-overview" class="tab-panel active"></div>
      <div id="tab-ops" class="tab-panel"></div>
      <div id="tab-labor" class="tab-panel"></div>
      <div id="tab-tech" class="tab-panel"></div>
      <div id="tab-media" class="tab-panel"></div>

      <div class="actions">
        <button id="btn-request" class="action">Request Info</button>
        <button id="btn-claim" class="action secondary">Apply for Verification</button>
        <button id="btn-compare" class="action secondary">Compare 3PL</button>
      </div>

      <div id="sheet-foot" class="kv" style="margin-top:10px; color:#9a9a9a; font-size:12px;"></div>
    </div>
  </div>

<script>
const STATE = {
  verifiedOnly: false,
  capacityOnly: false,
  showSubmarkets: true,
  showHeat: true,
  heatMode: "labor",
  rawGeo: null,
  filteredGeo: null,
  selected: null
};

const ATL_CENTER = [-84.39, 33.77];
const ATL_ZOOM = 10;

function asNum(v){
  if (v === null || v === undefined) return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

function computeHeatValue(p){
  if (STATE.heatMode === "labor") return asNum(p.labor_index) ?? 0.25;
  if (STATE.heatMode === "util"){
    const u = asNum(p.utilization);
    if (u === null) return 0.15;
    return Math.max(0, Math.min(1, 1 - u));
  }
  if (STATE.heatMode === "verified"){
    return (p.verified|0) === 1 ? 1 : 0.05;
  }
  return 0.2;
}

function filterAndDecorateGeo(rawGeo){
  if (!rawGeo?.features) return { type:"FeatureCollection", features:[] };

  const feats = rawGeo.features.map(f => {
    const p = { ...f.properties };
    p.verified = asNum(p.verified) ?? 0;
    p.inspected = asNum(p.inspected) ?? 0;
    p.utilization = asNum(p.utilization);
    p.labor_index = asNum(p.labor_index) ?? 0.25;
    p.heat_value = computeHeatValue(p);
    return { ...f, properties: p };
  });

  return { type:"FeatureCollection", features: feats };
}

async function start(){

  // Load config safely
  const configRes = await fetch("/api/config");
  if (!configRes.ok) throw new Error("Config failed");

  const config = await configRes.json();
  mapboxgl.accessToken = config.mapboxToken;

  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/blkluv/ckickwyl81snm19qste4bufgr",
    center: ATL_CENTER,
    zoom: ATL_ZOOM
  });

  map.addControl(new mapboxgl.NavigationControl());

  // Wait for style to fully load
  map.on("load", async () => {

    // Fetch facilities AFTER style loads
    try {
      const facilitiesRes = await fetch("/api/facilities");
      const rawGeo = await facilitiesRes.json();
      STATE.rawGeo = rawGeo;
      STATE.filteredGeo = filterAndDecorateGeo(rawGeo);
    } catch(e){
      console.error("Facilities failed:", e);
      STATE.filteredGeo = { type:"FeatureCollection", features:[] };
    }

    // Add source
    map.addSource("facilities", {
      type: "geojson",
      data: STATE.filteredGeo,
      cluster: true,
      clusterMaxZoom: 13,
      clusterRadius: 50
    });

    // Heatmap
    map.addLayer({
      id: "facilities-heat",
      type: "heatmap",
      source: "facilities",
      maxzoom: 13,
      paint: {
        "heatmap-weight": ["interpolate", ["linear"], ["get","heat_value"], 0, 0, 1, 1],
        "heatmap-intensity": 1,
        "heatmap-radius": 30,
        "heatmap-opacity": 0.35
      }
    });

    // Clusters
    map.addLayer({
      id: "clusters",
      type: "circle",
      source: "facilities",
      filter: ["has","point_count"],
      paint: {
        "circle-color": "#00ffea",
        "circle-radius": [
          "step",
          ["get","point_count"],
          18, 100,
          26, 300,
          34
        ],
        "circle-opacity": 0.85
      }
    });

    map.addLayer({
      id: "cluster-count",
      type: "symbol",
      source: "facilities",
      filter: ["has","point_count"],
      layout: {
        "text-field": ["get","point_count_abbreviated"],
        "text-size": 12
      },
      paint: {
        "text-color": "#000"
      }
    });

    // Points
    map.addLayer({
      id: "unclustered",
      type: "circle",
      source: "facilities",
      filter: ["!", ["has","point_count"]],
      paint: {
        "circle-color": [
          "case",
          ["==", ["get","verified"], 1], "#ffd000",
          "#00ffea"
        ],
        "circle-radius": 7,
        "circle-stroke-color": "#000",
        "circle-stroke-width": 1.5
      }
    });

    // Cluster click
    map.on("click", "clusters", (e) => {
      const features = map.queryRenderedFeatures(e.point, { layers:["clusters"] });
      const clusterId = features[0].properties.cluster_id;
      map.getSource("facilities").getClusterExpansionZoom(clusterId, (err, zoom) => {
        if (err) return;
        map.easeTo({ center: features[0].geometry.coordinates, zoom });
      });
    });

    // Point click
    map.on("click", "unclustered", (e) => {
      const f = e.features[0];
      console.log("Clicked:", f.properties.name);
    });

    map.on("mouseenter","clusters",()=> map.getCanvas().style.cursor="pointer");
    map.on("mouseleave","clusters",()=> map.getCanvas().style.cursor="");
    map.on("mouseenter","unclustered",()=> map.getCanvas().style.cursor="pointer");
    map.on("mouseleave","unclustered",()=> map.getCanvas().style.cursor="");

  });

}

start();
</script>
</body>
</html>