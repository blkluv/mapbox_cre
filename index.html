<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ATL Warehouse | UGC Command Center</title>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">

<style>
/* Your existing styles */
body { margin:0; padding:0; background:#0a0a0a; font-family:Arial; }
#map { position:absolute; top:60px; bottom:0; width:100%; }
#header { position:fixed; top:0; width:100%; height:60px; background:linear-gradient(90deg,#00ffea,#ff00ff); display:flex; align-items:center; justify-content:center; gap:30px; z-index:1000; font-weight:bold; }
#header a { color:#000; text-decoration:none; background:#fff; padding:6px 12px; border-radius:6px; font-size:14px; cursor:pointer; }
#counter { color: black; background: white; padding: 6px 12px; border-radius: 6px; font-size: 14px; font-weight: bold; }
#filter-bar { position: fixed; top: 70px; left: 10px; right: 10px; display: flex; gap: 10px; overflow-x: auto; padding: 10px; z-index: 999; }
.filter-btn { background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); border: 1px solid #ff00ff; border-radius: 25px; padding: 8px 20px; font-size: 13px; color: #ff00ff; cursor: pointer; white-space: nowrap; }
.filter-btn.active { background: #ff00ff; color: black; }
#ugc-feed { position: fixed; right: 10px; top: 140px; width: 90px; display: flex; flex-direction: column; gap: 12px; z-index: 1500; }
.ugc-thumb { width: 80px; height: 120px; border-radius: 16px; border: 3px solid #ff00ff; overflow: hidden; cursor: pointer; position: relative; box-shadow: 0 0 20px rgba(255,0,255,0.5); }
.ugc-thumb img { width: 100%; height: 100%; object-fit: cover; }
.ugc-thumb::after { content: '‚ñ∂'; position: absolute; bottom: 5px; right: 5px; background: #ff00ff; color: black; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
.ugc-views { position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; }
.tiktok-badge { background: #ff00ff; color: white; padding: 2px 8px; border-radius: 20px; font-size: 10px; display: inline-block; margin-left: 5px; }
#sheet { position: fixed; left: 10px; right: 10px; bottom: 10px; background: rgba(10,10,10,0.95); backdrop-filter: blur(20px); border-radius: 25px; border: 1px solid #00ffea; transform: translateY(120%); transition: transform 0.4s; z-index: 2000; padding: 25px; }
#sheet.open { transform: translateY(0); }
#close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
.stat-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
.mapboxgl-popup-content { background:#111 !important; color:#fff; border-radius:12px; }
.mapboxgl-popup-content h3 { color:#00ffea; margin-bottom:8px; }
#telegram-widget { position: fixed; bottom: 20px; left: 20px; background: #0088cc; color: white; padding: 12px 25px; border-radius: 40px; display: flex; align-items: center; gap: 12px; cursor: pointer; z-index: 2000; font-weight: bold; box-shadow: 0 0 25px rgba(0,136,204,0.6); }
.verified-badge { background: #00ff88; color: black; padding: 4px 10px; border-radius: 20px; font-size: 11px; }
</style>
</head>
<body>

<div id="header">
<a href="#" onclick="openTikTok()">üéµ @ATLWAREHOUSE</a>
<a href="#" onclick="openTelegram()">üì± @ATLWAREHOUSE</a>
<span id="counter">LOADING...</span>
</div>

<div id="filter-bar">
<div class="filter-btn active" onclick="filterFacilities('all')">ALL FACILITIES</div>
<div class="filter-btn" onclick="filterFacilities('vacant')">üü¢ VACANT NOW</div>
<div class="filter-btn" onclick="filterFacilities('ugc')">üé¨ HAS VIDEO</div>
</div>

<div id="map"></div>

<!-- UGC Feed -->
<div id="ugc-feed" id="ugcFeed"></div>

<!-- Telegram Widget -->
<div id="telegram-widget" onclick="openTelegram()">
<img src="https://telegram.org/img/website_icon.svg" width="24" height="24" style="filter: invert(1);">
<span>@atlwarehouse ‚Ä¢ <span id="telegram-online">2.3k</span> online</span>
</div>

<!-- Bottom Sheet -->
<div id="sheet">
<button id="close-btn" onclick="closeSheet()">√ó</button>
<div style="display:flex; justify-content:space-between; align-items:start;">
<div>
<h2 id="s-name" style="margin:0; color:#00ffea;">WAREHOUSE</h2>
<p id="s-loc" style="margin:5px 0; color:#888;">Atlanta Industrial District</p>
</div>
<div style="font-size:40px; font-weight:900; color:#00ffea;" id="s-grade">A+</div>
</div>

<!-- UGC Preview -->
<div id="ugc-preview" style="margin:15px 0; display:none;"></div>

<!-- Stats -->
<div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
<div class="stat-box">
<div style="font-size:10px; color:#00ffea;">POWER</div>
<div style="font-size:20px; font-weight:900;" id="s-power">4.5 MW</div>
</div>
<div class="stat-box">
<div style="font-size:10px; color:#ff00ff;">DRAYAGE</div>
<div style="font-size:20px; font-weight:900;" id="s-zone">INNER RING</div>
</div>
</div>

<!-- Action Buttons -->
<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
<button onclick="pinToTikTok()" style="padding:15px; border-radius:12px; border:none; background:linear-gradient(45deg, #ff00ff, #00ffea); color:black; font-weight:900; cursor:pointer;">
üé• PIN YOUR TIKTOK
</button>
<button onclick="joinTelegram()" style="padding:15px; border-radius:12px; border:1px solid #0088cc; background:transparent; color:#0088cc; font-weight:900; cursor:pointer;">
üí¨ DISCUSS
</button>
</div>
</div>

<script>
// Global variables
let map;
let allMarkers = [];
let currentFacility = null;

// TikTok Links
const TIKTOK = {
    main: "https://tiktok.com/@atlwarehouse",
    effect: "https://tiktok.com/@atlwarehouse/effect/warehouse-scanner",
    upload: (facility) => `https://tiktok.com/@atlwarehouse?caption=${encodeURIComponent(`üìç ${facility} on @atlwarehouse map! #ATLWarehouse`)}`
};

// Telegram Links
const TELEGRAM = {
    group: "https://t.me/atlwarehouse",
    discussion: (facility) => `https://t.me/atlwarehouse?start=${encodeURIComponent(facility)}`
};

// Initialize - FETCH TOKEN FROM YOUR API
async function init() {
    try {
        // Get token from your secure API endpoint
        const response = await fetch('/api/config');
        const config = await response.json();
        
        // Set token from server
        mapboxgl.accessToken = config.mapboxToken;
        
        // Initialize map
        map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/dark-v11",
            center: [-84.39, 33.77],
            zoom: 10
        });
        
        map.addControl(new mapboxgl.NavigationControl());
        
        map.on('load', () => {
            document.getElementById('counter').innerHTML = "‚úì MAP LOADED";
            loadWarehouses();
            loadUGCFeed();
        });
        
    } catch (err) {
        console.error("Init error:", err);
        document.getElementById('counter').innerHTML = "‚ùå CONFIG ERROR";
    }
}

// Load warehouses from Overpass
async function loadWarehouses() {
    try {
        document.getElementById('counter').innerHTML = "üîç SCANNING...";
        
        const query = `
        [out:json][timeout:25];
        (
          node["building"="warehouse"](33.45,-84.70,34.05,-84.10);
          way["building"="warehouse"](33.45,-84.70,34.05,-84.10);
        );
        out center;
        `;
        
        const response = await fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            body: query
        });
        
        const data = await response.json();
        document.getElementById('counter').innerHTML = `üìä ${data.elements.length} FACILITIES`;
        
        data.elements.forEach((el, index) => {
            let coords;
            
            if (el.type === "node") {
                coords = [el.lon, el.lat];
            } else if (el.type === "way" && el.center) {
                coords = [el.center.lon, el.center.lat];
            } else return;
            
            const name = el.tags?.name || `Warehouse ${index + 1}`;
            const hasUGC = Math.random() > 0.6;
            
            // Create marker
            const markerEl = document.createElement('div');
            markerEl.style.width = '16px';
            markerEl.style.height = '16px';
            markerEl.style.backgroundColor = hasUGC ? '#ff00ff' : '#00ffea';
            markerEl.style.borderRadius = '50%';
            markerEl.style.boxShadow = hasUGC ? '0 0 15px #ff00ff' : '0 0 15px #00ffea';
            markerEl.style.cursor = 'pointer';
            markerEl.style.border = '2px solid white';
            
            const marker = new mapboxgl.Marker({ element: markerEl })
                .setLngLat(coords)
                .addTo(map);
            
            marker._data = {
                id: `w-${index}`,
                name: name,
                power: (Math.random() * 5 + 1).toFixed(1),
                grade: ['A+', 'A', 'B+'][Math.floor(Math.random() * 3)],
                utilization: Math.floor(Math.random() * 100),
                hasUGC: hasUGC
            };
            
            markerEl.addEventListener('click', () => {
                openSheet(marker._data);
                currentFacility = marker._data;
            });
            
            // Popup
            const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
                <div style="max-width:250px;">
                    <h3 style="color:#00ffea;">${name}</h3>
                    <p>üì¶ ${marker._data.utilization}% utilized</p>
                    ${hasUGC ? '<p style="color:#ff00ff;">üé¨ Has TikTok UGC</p>' : ''}
                    <button onclick="window.pinFromPopup('${marker._data.id}')" style="
                        width:100%;
                        padding:10px;
                        background:#ff00ff;
                        color:white;
                        border:none;
                        border-radius:8px;
                        margin-top:10px;
                        cursor:pointer;">
                        üìπ Pin Your TikTok
                    </button>
                </div>
            `);
            
            marker.setPopup(popup);
            allMarkers.push(marker);
        });
        
    } catch (err) {
        console.error("Error:", err);
        document.getElementById('counter').innerHTML = "‚ö†Ô∏è OFFLINE";
    }
}

// Load UGC Feed
function loadUGCFetch() {
    const feed = document.getElementById('ugc-feed');
    feed.innerHTML = '';
    
    for (let i = 0; i < 3; i++) {
        const thumb = document.createElement('div');
        thumb.className = 'ugc-thumb';
        thumb.onclick = () => window.open(TIKTOK.main, '_blank');
        thumb.innerHTML = `
            <img src="https://via.placeholder.com/80x120/ff00ff/000000?text=üé¨">
            <span class="ugc-views">${Math.floor(Math.random() * 20 + 1)}K</span>
        `;
        feed.appendChild(thumb);
    }
}

// Filter facilities
function filterFacilities(filter) {
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    allMarkers.forEach(marker => {
        if (!marker._data) return;
        
        switch(filter) {
            case 'all':
                marker.getElement().style.display = 'block';
                break;
            case 'vacant':
                marker.getElement().style.display = marker._data.utilization < 30 ? 'block' : 'none';
                break;
            case 'ugc':
                marker.getElement().style.display = marker._data.hasUGC ? 'block' : 'none';
                break;
        }
    });
}

// Sheet functions
function openSheet(data) {
    document.getElementById('s-name').innerText = data.name;
    document.getElementById('s-grade').innerText = data.grade;
    document.getElementById('s-power').innerText = data.power + " MW";
    document.getElementById('s-zone').innerText = data.utilization > 70 ? "HIGH TRAFFIC" : "NORMAL";
    
    const preview = document.getElementById('ugc-preview');
    if (data.hasUGC) {
        preview.style.display = 'block';
        preview.innerHTML = `
            <div style="background:rgba(255,0,255,0.1); padding:10px; border-radius:12px;">
                <span style="color:#ff00ff;">üé¨ 3 TikTok clips available</span>
                <button onclick="window.open('${TIKTOK.main}','_blank')" style="margin-left:10px; padding:5px 10px; background:#ff00ff; border:none; border-radius:15px;">Watch</button>
            </div>
        `;
    } else {
        preview.style.display = 'none';
    }
    
    document.getElementById('sheet').classList.add('open');
}

function closeSheet() {
    document.getElementById('sheet').classList.remove('open');
}

// TikTok functions
function openTikTok() {
    window.open(TIKTOK.main, '_blank');
}

function pinToTikTok() {
    if (!currentFacility) {
        alert('Select a warehouse first');
        return;
    }
    window.open(TIKTOK.upload(currentFacility.name), '_blank');
    setTimeout(() => {
        alert('üì± DM @atlwarehouse on TikTok to get pinned!');
    }, 1000);
}

// Global popup function
window.pinFromPopup = function(id) {
    const facility = allMarkers.find(m => m._data.id === id)?._data;
    if (facility) {
        currentFacility = facility;
        pinToTikTok();
    }
};

// Telegram functions
function openTelegram() {
    window.open(TELEGRAM.group, '_blank');
}

function joinTelegram() {
    if (!currentFacility) {
        openTelegram();
        return;
    }
    window.open(TELEGRAM.discussion(currentFacility.name), '_blank');
}

// Start the app
init();
</script>

</body>
</html>
