<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ATL WAREHOUSE | REAL-TIME INTELLIGENCE</title>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <style>
        /* EXACT STYLES FROM YOUR SCREENSHOT */
        :root {
            --aqua: #00ffea;
            --pink: #ff00ff;
            --glass: rgba(10, 10, 10, 0.95);
            --border: rgba(255, 255, 255, 0.1);
        }

        body { margin:0; padding:0; background:#0a0a0a; font-family: 'Inter', sans-serif; color: white; overflow: hidden; }
        #map { position:absolute; top:0; bottom:0; width:100%; height:100%; }

        /* Header exactly as screenshot */
        #header {
            position: fixed; top: 10px; left: 10px; right: 10px; height: 60px;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            border: 1px solid var(--aqua); border-radius: 30px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000;
            box-shadow: 0 0 20px rgba(0,255,234,0.3);
        }

        .header-left { display: flex; gap: 15px; }
        .header-right { display: flex; gap: 15px; align-items: center; }

        .header-btn {
            background: transparent; border: 1px solid var(--aqua);
            color: var(--aqua); padding: 8px 20px; border-radius: 25px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            text-decoration: none; transition: all 0.3s;
            white-space: nowrap;
        }
        .header-btn:hover { background: var(--aqua); color: black; }

        #counter {
            background: linear-gradient(90deg, var(--aqua), var(--pink));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-size: 14px; font-weight: 900;
            margin-right: 15px;
        }

        /* Filter bar exactly as screenshot */
        #filter-bar {
            position: fixed; top: 80px; left: 10px; right: 10px;
            display: flex; gap: 10px; overflow-x: auto; padding: 10px;
            z-index: 999; scrollbar-width: none;
        }
        .filter-btn {
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            border: 1px solid var(--pink); border-radius: 25px;
            padding: 8px 20px; font-size: 13px; white-space: nowrap;
            color: var(--pink); cursor: pointer;
            box-shadow: 0 0 10px rgba(255,0,255,0.3);
        }
        .filter-btn.active { background: var(--pink); color: black; font-weight: bold; }

        /* Bottom sheet */
        #sheet {
            position: fixed; left: 10px; right: 10px; bottom: 10px;
            background: var(--glass); backdrop-filter: blur(20px);
            border-radius: 25px; border: 1px solid var(--aqua);
            transform: translateY(120%); transition: transform 0.4s;
            z-index: 2000; padding: 25px;
        }
        #sheet.open { transform: translateY(0); }
        
        #close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: white; font-size: 24px; cursor: pointer; }

        .stat-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .grade-badge { font-size: 40px; font-weight: 900; color: var(--aqua); text-shadow: 0 0 10px var(--aqua); }
    </style>
</head>
<body>

    <!-- Header with exact screenshot layout -->
    <div id="header">
        <div class="header-left">
            <a href="#" class="header-btn" onclick="openAR('vacancy')">VACANCY SCAN</a>
            <a href="#" class="header-btn" onclick="openAR('utilization')">UTILIZATION</a>
            <a href="#" class="header-btn" onclick="openAR('drayage')">DRAYAGE</a>
        </div>
        <div class="header-right">
            <span id="counter">SCANNING NETWORK...</span>
            <a href="#" class="header-btn" onclick="openUGCUpload()">UPLOAD TIKTOK</a>
        </div>
    </div>

    <!-- Filter bar exactly as screenshot -->
    <div id="filter-bar">
        <div class="filter-btn active" onclick="applyFilter('all')">ALL FACILITIES</div>
        <div class="filter-btn" onclick="applyFilter('vacant')">VACANT NOW</div>
        <div class="filter-btn" onclick="applyFilter('traffic')">HIGH TRAFFIC</div>
        <div class="filter-btn" onclick="applyFilter('verified')">VERIFIED</div>
        <div class="filter-btn" onclick="applyFilter('ugc')">HAS UGC</div>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Bottom Sheet -->
    <div id="sheet">
        <button id="close-btn" onclick="closeSheet()">Ã—</button>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h2 id="s-name" style="margin:0; color:var(--aqua);">WAREHOUSE</h2>
                <p id="s-loc" style="margin:5px 0; color:#888;">Atlanta Industrial District</p>
            </div>
            <div class="grade-badge" id="s-grade">A</div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px;">
            <div class="stat-box">
                <div style="font-size:10px; color:var(--aqua);">POWER CAPACITY</div>
                <div style="font-size:20px; font-weight:900;" id="s-power">4.5 MW</div>
            </div>
            <div class="stat-box">
                <div style="font-size:10px; color:var(--pink);">DRAYAGE ZONE</div>
                <div style="font-size:20px; font-weight:900;" id="s-zone">INNER RING</div>
            </div>
        </div>

        <button onclick="requestInspection()" style="width:100%; margin-top:30px; padding:18px; border-radius:12px; border:none; background:linear-gradient(90deg, var(--aqua), var(--pink)); color:black; font-weight:900; cursor:pointer;">
            REQUEST SITE INSPECTION
        </button>
    </div>

<script>
    // IMPORTANT: Use environment variable
    mapboxgl.accessToken = "YOUR_MAPBOX_TOKEN"; // Replace or use from Vercel env
    
    const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/dark-v11",
        center: [-84.39, 33.77], // Atlanta
        zoom: 10,
        pitch: 45
    });

    // Store all markers
    let markers = [];

    // Load from your API endpoint
    async function loadFacilities() {
        try {
            document.getElementById('counter').innerText = "SCANNING NETWORK...";
            
            // CALL YOUR API - THIS IS THE FIX
            const response = await fetch('/api/facilities');
            
            if (!response.ok) {
                throw new Error(`API returned ${response.status}`);
            }
            
            const geojson = await response.json();
            
            if (!geojson.features || geojson.features.length === 0) {
                console.warn("No facilities returned from API");
                document.getElementById('counter').innerText = "NO FACILITIES FOUND";
                return;
            }
            
            // Update counter
            document.getElementById('counter').innerText = `NETWORK: ${geojson.features.length} UNITS`;
            
            // Clear existing markers
            markers.forEach(m => m.remove());
            markers = [];
            
            // Add markers for each facility
            geojson.features.forEach(feature => {
                const coords = feature.geometry.coordinates;
                const props = feature.properties;
                
                // Skip invalid coordinates
                if (!coords || coords.length < 2 || !coords[0] || !coords[1]) return;
                
                // Create marker element
                const el = document.createElement('div');
                el.className = 'custom-marker';
                el.style.width = '14px';
                el.style.height = '14px';
                el.style.backgroundColor = props.verification_status === 'verified' ? '#00ffea' : '#ff00ff';
                el.style.borderRadius = '50%';
                el.style.boxShadow = props.verification_status === 'verified' ? '0 0 12px #00ffea' : '0 0 12px #ff00ff';
                el.style.cursor = 'pointer';
                el.style.border = '2px solid black';
                
                // Create popup with basic info
                const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
                    <div style="color:black; padding:5px;">
                        <strong>${props.name || 'Warehouse'}</strong><br>
                        <span style="color:#666;">${props.utilization ? props.utilization + '% utilized' : 'Status unknown'}</span>
                    </div>
                `);
                
                // Add marker to map
                const marker = new mapboxgl.Marker({ element: el })
                    .setLngLat(coords)
                    .setPopup(popup)
                    .addTo(map);
                
                markers.push(marker);
                
                // Open sheet on click
                el.addEventListener('click', () => {
                    openSheet(props);
                });
            });
            
            // If we have facilities, fit bounds to show them all
            if (geojson.features.length > 0) {
                const bounds = new mapboxgl.LngLatBounds();
                geojson.features.forEach(f => {
                    bounds.extend(f.geometry.coordinates);
                });
                map.fitBounds(bounds, { padding: 50 });
            }
            
        } catch (err) {
            console.error("Failed to load facilities:", err);
            document.getElementById('counter').innerText = "OFFLINE - CHECK API";
            
            // FALLBACK: Show some sample data for demonstration
            showFallbackData();
        }
    }

    // Fallback data if API fails (for testing)
    function showFallbackData() {
        const sampleFacilities = [
            { name: "ATL Logistics Center", coords: [-84.39, 33.77], grade: "A+" },
            { name: "Fulton Industrial", coords: [-84.42, 33.75], grade: "B+" },
            { name: "South Atlanta DC", coords: [-84.36, 33.69], grade: "A" },
            { name: "Airport Warehouse", coords: [-84.44, 33.64], grade: "A-" }
        ];
        
        document.getElementById('counter').innerText = `NETWORK: ${sampleFacilities.length} UNITS (DEMO)`;
        
        sampleFacilities.forEach(f => {
            const el = document.createElement('div');
            el.style.width = '14px';
            el.style.height = '14px';
            el.style.backgroundColor = '#00ffea';
            el.style.borderRadius = '50%';
            el.style.boxShadow = '0 0 12px #00ffea';
            el.style.cursor = 'pointer';
            el.style.border = '2px solid black';
            
            new mapboxgl.Marker({ element: el })
                .setLngLat(f.coords)
                .addTo(map);
            
            el.addEventListener('click', () => {
                openSheet({
                    name: f.name,
                    grade: f.grade,
                    power: (Math.random() * 5 + 1).toFixed(1),
                    verification_status: "verified"
                });
            });
        });
    }

    function openSheet(data) {
        document.getElementById('s-name').innerText = data.name || "Industrial Facility";
        document.getElementById('s-grade').innerText = data.grade || "A";
        document.getElementById('s-power').innerText = (data.power_mw || data.power || (Math.random() * 5).toFixed(1)) + " MW";
        document.getElementById('s-zone').innerText = data.drayage_zone || "INNER RING";
        document.getElementById('sheet').classList.add('open');
    }

    function closeSheet() {
        document.getElementById('sheet').classList.remove('open');
    }

    function applyFilter(filter) {
        document.querySelectorAll('.filter-btn').forEach(f => f.classList.remove('active'));
        event.target.classList.add('active');
        
        // Filter logic here
        console.log(`Filtering: ${filter}`);
    }

    function openAR(type) {
        alert(`ðŸ“± Opening AR ${type} view - coming soon!`);
    }

    function openUGCUpload() {
        window.open('https://tiktok.com/@atlwarehouse', '_blank');
    }

    function requestInspection() {
        alert('Inspection requested - community will verify');
    }

    // Wait for map to load then get facilities
    map.on('load', () => {
        console.log("Map loaded, fetching facilities...");
        loadFacilities();
    });

    // Add error handling
    map.on('error', (e) => {
        console.error("Map error:", e);
    });

</script>
</body>
</html>
